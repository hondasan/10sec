<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>10ç§’ã´ã£ãŸã‚Šã‚²ãƒ¼ãƒ </title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin: 20px;
      position: relative;
      overflow-x: hidden;
      overflow-y: hidden;
    }
    h1 {
      font-size: 1.8em;
      margin-bottom: 30px;
    }

    /* ãƒœã‚¿ãƒ³ã‚’ä¸­å¤®ã«é…ç½® */
    .button-container {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 20px;
    }

    /* START/STOPãƒœã‚¿ãƒ³ */
    #toggleBtn {
      width: 50vmin;
      height: 50vmin;
      border-radius: 50%;
      background-color: #007bff; /* STARTæ™‚ã®è‰² */
      color: #fff;
      font-size: 3rem;  /* æ–‡å­—ã‚’å¤§ãã */
      border: none;
      outline: none;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.3s;
    }
    #toggleBtn:active {
      opacity: 0.9;
    }

    /* æŠ¼ã—ãŸã¨ãã®è»½ã„æ‹¡å¤§ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    .pressAnimation {
      animation: pressAnim 0.2s forwards;
    }
    @keyframes pressAnim {
      50% {
        transform: scale(1.1);
      }
      100% {
        transform: scale(1);
      }
    }

    /* ç¶™ç¶šçš„ã«å‡ºç¾ã™ã‚‹ãƒ©ãƒ³ãƒ€ãƒ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®è¦ç´  */
    .random-animation {
      position: fixed;
      font-size: 2rem;
      pointer-events: none;
      opacity: 0;
      animation: floatAnim 2s linear forwards;
      z-index: 999;
    }
    @keyframes floatAnim {
      0% {
        transform: translate(0, 0) scale(1);
        opacity: 1;
      }
      100% {
        transform: translate(0, -200px) scale(0.5);
        opacity: 0;
      }
    }

    /* çµæœè¡¨ç¤º */
    #result {
      font-size: 1.2em;
      margin: 15px 0;
      white-space: pre-wrap; /* \nã‚’æ”¹è¡Œã§è¡¨ç¤º */
      min-height: 6em;       /* ã‚ã‚‹ç¨‹åº¦ã®é«˜ã•ã‚’ç¢ºä¿ã—ã¦ã€ç”»é¢ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®ã‚ºãƒ¬ã‚’é˜²ã */
    }

    /* è¨ˆæ¸¬æ™‚é–“ã‚’ã‚ˆã‚Šç›®ç«‹ã¤ã‚ˆã†ã«ã™ã‚‹ */
    .elapsed-time {
      font-size: 1.6em;
      font-weight: bold;
      color: #e74c3c; /* red */
      display: inline-block;
      margin-bottom: 5px;
    }

    /* ãƒ©ãƒ³ã‚¯è¡¨ç¤ºã‚’å¤§ããã™ã‚‹ */
    .rank-text {
      font-size: 2em;
      font-weight: bold;
    }

    /* ãƒ©ãƒ³ã‚¯ã®è‰²ä»˜ã‘ */
    .rank-S { color: #f1c40f; } /* gold */
    .rank-A { color: #e67e22; } /* orange */
    .rank-B { color: #3498db; } /* blue */
    .rank-C { color: #2ecc71; } /* green */
    .rank-D { color: #9b59b6; } /* purple */
    .rank-E { color: #e74c3c; } /* red  */

    /* Sãƒ©ãƒ³ã‚¯ã§ç¥ç¦ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆæ˜ŸãŒèˆã†ï¼‰ */
    .star {
      position: fixed;
      color: #f1c40f;  /* gold */
      font-size: 2em;
      pointer-events: none;
      animation: starFall 1.5s linear forwards;
      z-index: 9999;
    }
    @keyframes starFall {
      0% {
        opacity: 1;
        transform: translateY(-50px) rotate(0deg);
      }
      100% {
        opacity: 0;
        transform: translateY(500px) rotate(360deg);
      }
    }

    /* ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º */
    #rankingContainer {
      margin-top: 20px;
      text-align: left;
      max-width: 420px;
      margin-left: auto;
      margin-right: auto;
      font-size: 0.95em;
    }
    .ranking-title {
      font-size: 1.2em;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .ranking-item {
      margin-bottom: 5px;
      line-height: 1.4em;
    }
  </style>
</head>
<body>

  <h1>10ç§’ã´ã£ãŸã‚Šã‚²ãƒ¼ãƒ </h1>

  <div class="button-container">
    <button id="toggleBtn">START</button>
  </div>

  <div id="result"></div>

  <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºé ˜åŸŸ -->
  <div id="rankingContainer">
    <div class="ranking-title">Top 5 Records (Best to Worse)</div>
    <div id="rankingList"></div>
  </div>

  <script>
    let startTime = 0;        // STARTãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸæ™‚åˆ»
    let isRunning = false;    // ã‚¿ã‚¤ãƒãƒ¼ãŒå‹•ä½œä¸­ã‹ã©ã†ã‹
    let animationRunning = false; // ãƒ©ãƒ³ãƒ€ãƒ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åˆ¶å¾¡

    // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã¯æœ€å¤§100ä»¶ã‚’ä¿æŒ
    const MAX_RECORDS = 100;
    // è¡¨ç¤ºã¯ä¸Šä½5ä»¶
    const DISPLAY_LIMIT = 5;
    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä¸Šã«ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”¨ã®ã‚­ãƒ¼
    const STORAGE_KEY = "tenSecRankingV3";

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«æ—¢å­˜ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¡¨ç¤º
    window.addEventListener('DOMContentLoaded', () => {
      displayRanking();
    });

    // â˜… ãƒ©ãƒ³ã‚¯åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ (diff: 10ç§’ã¨ã®å·®)
    //   S: < 0.01
    //   A: < 0.1
    //   B: < 0.3
    //   C: < 0.7
    //   D: < 1.0
    //   E: ãã‚Œä»¥ä¸Š
    function getRank(diff) {
      if (diff < 0.01) {
        return "S";
      } else if (diff < 0.1) {
        return "A";
      } else if (diff < 0.3) {
        return "B";
      } else if (diff < 0.7) {
        return "C";
      } else if (diff < 1.0) {
        return "D";
      } else {
        return "E";
      }
    }

    // ===== ãƒ©ãƒ³ãƒ€ãƒ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–¢ä¿‚ =====
    // ç¶™ç¶šçš„ã«ç”»é¢ä¸Šã«ãƒ©ãƒ³ãƒ€ãƒ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‡ºã™
    // ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒä¸è¦å‰‡ã«ãªã‚‹ã‚ˆã†ã«ã€ãƒ©ãƒ³ãƒ€ãƒ ãªé–“éš”ã§å†å¸°å‘¼ã³å‡ºã—
    function startRandomAnimation() {
      if (animationRunning) return;
      animationRunning = true;

      (function spawnNext() {
        // 0.8ç§’ ï½ 3ç§’ ã®é–“ã§ãƒ©ãƒ³ãƒ€ãƒ ã«å†ç™ºç”Ÿ
        const nextDelay = Math.random() * 2200 + 800;

        // ãƒ©ãƒ³ãƒ€ãƒ è¦ç´ ç”Ÿæˆ
        spawnRandomElement();

        // å†å¸°å‘¼ã³å‡ºã—ã§ç¹°ã‚Šè¿”ã™
        setTimeout(() => {
          if (isRunning) {
            spawnNext();
          } else {
            animationRunning = false;
          }
        }, nextDelay);
      })();
    }

    // ç”»é¢ã«ãƒ©ãƒ³ãƒ€ãƒ ãªæ–‡å­—ã‚„å›³å½¢ã‚’è¡¨ç¤ºã™ã‚‹ï¼ˆä¸è¦å‰‡ã«å‡ºã¦ä¸Šã¸æ¶ˆãˆã‚‹ï¼‰
    function spawnRandomElement() {
      const element = document.createElement('div');
      element.classList.add('random-animation');

      // çµµæ–‡å­—å€™è£œ
      const emojis = ["âœ¨","ğŸ”¥","ğŸ’«","ğŸŒ¿","âš¡","ğŸ‰","ğŸ¶","ğŸ’¥","ğŸ€","ğŸŒ€","ğŸ•¸","ğŸŒˆ"];
      const randomEmoji = emojis[Math.floor(Math.random() * emojis.length)];
      element.textContent = randomEmoji;

      // ç”»é¢ä¸Šã®ãƒ©ãƒ³ãƒ€ãƒ ä½ç½®ï¼ˆæ¨ªæ–¹å‘ï¼‰
      const xPos = Math.random() * window.innerWidth * 0.8; 
      const yPos = Math.random() * window.innerHeight * 0.8 + window.innerHeight; 
      element.style.left = xPos + "px";
      element.style.top = yPos + "px";

      // ãƒ©ãƒ³ãƒ€ãƒ ãªè‰²ãƒ»ã‚µã‚¤ã‚º
      const colors = ["#e74c3c","#9b59b6","#3498db","#2ecc71","#e67e22","#f1c40f"];
      element.style.color = colors[Math.floor(Math.random() * colors.length)];
      const size = Math.random() * 2 + 1; // 1ï½3å€
      element.style.fontSize = (2 * size) + "rem";

      document.body.appendChild(element);
      // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†å¾Œã«è¦ç´ ã‚’å‰Šé™¤
      element.addEventListener('animationend', () => {
        element.remove();
      });
    }

    // Sãƒ©ãƒ³ã‚¯ç¥ç¦ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ (æ˜ŸãŒèˆã†)
    function spawnBlessingAnimation() {
      for (let i = 0; i < 20; i++) {
        const star = document.createElement('div');
        star.classList.add('star');
        star.textContent = 'â˜…';
        const xPos = Math.random() * window.innerWidth;
        const yPos = Math.random() * 100 - 100; 
        star.style.left = `${xPos}px`;
        star.style.top = `${yPos}px`;

        document.body.appendChild(star);
        star.addEventListener('animationend', () => {
          star.remove();
        });
      }
    }

    // START/STOP ãƒœã‚¿ãƒ³
    const toggleBtn = document.getElementById("toggleBtn");
    toggleBtn.addEventListener("click", function() {
      // æŠ¼ã—ãŸã‚¢ãƒ‹ãƒ¡ä»˜ä¸â†’çµ‚äº†å¾Œã«å‰Šé™¤
      toggleBtn.classList.add("pressAnimation");
      toggleBtn.addEventListener("animationend", () => {
        toggleBtn.classList.remove("pressAnimation");
      }, { once: true });

      if (!isRunning) {
        // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
        isRunning = true;
        startTime = performance.now();

        this.textContent = "STOP";
        this.style.backgroundColor = "#dc3545"; // STOPæ™‚ã®è‰²

        document.getElementById("result").textContent = "";
        startRandomAnimation();  // ãƒ©ãƒ³ãƒ€ãƒ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹

      } else {
        // ã‚¿ã‚¤ãƒãƒ¼åœæ­¢
        isRunning = false;
        const endTime = performance.now();
        const elapsedSec = (endTime - startTime) / 1000;
        const diff = Math.abs(elapsedSec - 10);

        // ãƒ©ãƒ³ã‚¯
        const rankSymbol = getRank(diff);

        // çµæœè¡¨ç¤º (æ™‚é–“ã‚’ã‚ˆã‚Šç›®ç«‹ãŸã›ã‚‹)
        const resultEl = document.getElementById("result");
        const rankHtml = `<span class="rank-text rank-${rankSymbol}">${rankSymbol}</span>`;
        resultEl.innerHTML = 
          `ã‚ãªãŸã®ã‚¿ã‚¤ãƒ :\n` +
          `<span class="elapsed-time">${elapsedSec.toFixed(5)} s</span>\n\n` +
          `10ç§’ã¨ã®å·®: ${diff.toFixed(5)} s\n` +
          `ãƒ©ãƒ³ã‚¯: ${rankHtml}\n`;

        // ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ›´æ–°ã—ã€ä»Šå›ã®é †ä½ã‚’å–å¾—
        const currentRank = updateRanking(diff, elapsedSec);

        // Sãƒ©ãƒ³ã‚¯ãªã‚‰æ˜Ÿã®ç¥ç¦ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        if (rankSymbol === "S") {
          spawnBlessingAnimation();
        }

        // 5ä½ä»¥å†…ãªã‚‰ç¥ç¦ã€6ä½ä»¥ä¸Šãªã‚‰ç…½ã‚Š (å¨äºŒç—…é¢¨ æ—¥æœ¬èª)
        if (currentRank <= 5) {
          // ç¥ç¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¾‹
          resultEl.innerHTML += `\nã€Œãµã¯ã¯ã¯â€¦æ¼†é»’ã®ç¥ç¦ã‚’å—ã‘ã‚‹ãŒã„ã„ã€é¸ã°ã‚Œã—è€…ã‚ˆâ€¦ï¼ã€`;
        } else {
          // ç…½ã‚Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¾‹
          resultEl.innerHTML += `\nã€Œè²´æ§˜ãªã©é—‡ã®åº•ã«æ²ˆã‚€é‹å‘½â€¦ç²¾é€²ã™ã‚‹ãŒã„ã„ã€‚ (${currentRank}ä½)ã€`;
        }

        // ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’æˆ»ã™
        this.textContent = "START";
        this.style.backgroundColor = "#007bff";
      }
    });

    // ===== ãƒ©ãƒ³ã‚­ãƒ³ã‚°å‡¦ç† =====
    // ãƒ©ãƒ³ã‚­ãƒ³ã‚°(æœ€å¤§100ä»¶)ã‚’ãƒ­ãƒ¼ãƒ‰
    function loadRanking() {
      const data = localStorage.getItem(STORAGE_KEY);
      if (data) {
        return JSON.parse(data);
      }
      return [];
    }

    // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ä¿å­˜
    function saveRanking(ranking) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(ranking));
    }

    // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ç”»é¢è¡¨ç¤º (ä¸Šä½5å)
    function displayRanking() {
      const rankingListEl = document.getElementById("rankingList");
      rankingListEl.innerHTML = ""; // ãƒªã‚»ãƒƒãƒˆ

      const rankingData = loadRanking();
      if (rankingData.length === 0) {
        rankingListEl.textContent = "ã¾ã è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
        return;
      }

      // ä¸Šä½5ä»¶ã®ã¿è¡¨ç¤º
      const top5 = rankingData.slice(0, DISPLAY_LIMIT);
      top5.forEach((item, idx) => {
        const rankSymbol = getRank(item.difference);
        const rankClass = `rank-${rankSymbol}`;
        const div = document.createElement('div');
        div.className = "ranking-item";
        // â€œdifferenceâ€ãŒ10ç§’ã¨ã®å·®, â€œtimeElapsedâ€ãŒå®Ÿéš›ã®è¨ˆæ¸¬ç§’æ•°
        div.innerHTML =
          `<strong>${idx+1}ä½</strong> : ` +
          `<span class="${rankClass}">${item.difference.toFixed(5)}s</span> / ` +
          `${item.timeElapsed.toFixed(5)}s / ` +
          `${item.date} (ãƒ©ãƒ³ã‚¯: ${rankSymbol})`;
        rankingListEl.appendChild(div);
      });
    }

    // æ–°ã—ã„è¨˜éŒ²ã‚’ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«åæ˜ ã—ã€ä»Šå›ã®é †ä½ã‚’è¿”ã™
    function updateRanking(diff, elapsedSec) {
      // æ—¢å­˜ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’å–å¾—
      let rankingData = loadRanking();

      // ä»Šå›ã®è¨˜éŒ²ã‚’ä½œæˆ
      const now = new Date();
      const record = {
        difference: diff,
        timeElapsed: elapsedSec,
        date: formatDate(now),   // yyyy-MM-dd HH:mm:ss
        timestamp: now.getTime() // ã‚½ãƒ¼ãƒˆæ™‚ã«ä½¿ã†(åŒã˜å·®ã§ã®é †åº)
      };

      // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã¸è¿½åŠ 
      rankingData.push(record);

      // å·®ãŒå°ã•ã„é †ã«ã‚½ãƒ¼ãƒˆã€‚diffãŒåŒã˜ãªã‚‰timestampãŒå°ã•ã„(å¤ã„)æ–¹ãŒå…ˆã€æ–°ã—ã„æ–¹ãŒå¾Œ
      rankingData.sort((a, b) => {
        if (a.difference === b.difference) {
          return a.timestamp - b.timestamp; 
        }
        return a.difference - b.difference;
      });

      // ä¸Šä½100ä»¶ã®ã¿ä¿æŒ
      rankingData = rankingData.slice(0, MAX_RECORDS);

      // ç¾åœ¨ã®è¨˜éŒ²ãŒä½•ç•ªç›®ã‹èª¿ã¹ã‚‹ (0-based index) 
      // åŒã˜å·®ã®ã¨ãã¯å¤ã„æ–¹ â†’ æ–°ã—ã„æ–¹ã®é †ãªã®ã§ã€ä»Šå›ã®è¨˜éŒ²ã¯ã€Œæœ€å¾Œã«å‡ºç¾ã™ã‚‹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã€
      let newRecordIndex = -1;
      for (let i = rankingData.length - 1; i >= 0; i--) {
        if (rankingData[i].timestamp === record.timestamp) {
          newRecordIndex = i;
          break;
        }
      }
      const finalRank = newRecordIndex + 1; // 1-based rank

      // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ä¿å­˜ã—ã€è¡¨ç¤ºæ›´æ–°
      saveRanking(rankingData);
      displayRanking();

      return finalRank;
    }

    // æ—¥æ™‚ã‚’ yyyy-MM-dd HH:mm:ss å½¢å¼ã§è¿”ã™
    function formatDate(dateObj) {
      const yyyy = dateObj.getFullYear();
      const mm = String(dateObj.getMonth()+1).padStart(2, '0');
      const dd = String(dateObj.getDate()).padStart(2, '0');
      const hh = String(dateObj.getHours()).padStart(2, '0');
      const min = String(dateObj.getMinutes()).padStart(2, '0');
      const ss = String(dateObj.getSeconds()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd} ${hh}:${min}:${ss}`;
    }
  </script>
</body>
</html>